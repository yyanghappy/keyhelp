# 技术方案设计

## 架构设计

### 项目结构

```
lib/
├── main.dart                 # 应用入口
├── app.dart                  # 根组件
├── config/                   # 配置
│   ├── theme.dart            # 主题配置
│   └── constants.dart        # 常量定义
├── core/                     # 核心功能
│   ├── services/             # 服务层
│   │   ├── accessibility_service.dart  # 无障碍服务
│   │   ├── script_recorder.dart        # 脚本录制器
│   │   ├── script_executor.dart        # 脚本执行器
│   │   └── scheduler.dart              # 定时任务调度
│   ├── models/              # 数据模型
│   │   ├── script.dart      # 脚本模型
│   │   ├── action.dart      # 动作模型
│   │   └── scheduled_task.dart # 定时任务模型
│   └── repositories/       # 数据仓库
│       ├── script_repository.dart
│       └── task_repository.dart
├── features/                # 功能模块
│   ├── home/               # 首页
│   ├── record/             # 录制页面
│   ├── scripts/            # 脚本列表
│   ├── execute/            # 执行页面
│   └── schedule/           # 定时任务
└── shared/                 # 共享组件
    ├── widgets/            # 通用组件
    └── utils/              # 工具类
```

### 核心功能实现

#### 1. 脚本录制 (Script Recording)

**技术方案**:
- 使用AccessibilityService监听用户操作
- 记录触控坐标、动作类型（点击/滑动/长按）
- 支持流程控制（条件/循环）

**关键点**:
```dart
// 录制的数据结构
enum ActionType { tap, swipe, longPress, wait, condition, loop }

class ScriptAction {
  final ActionType type;
  final Offset? position;
  final Offset? endPosition; // 滑动终点
  final Duration? delay;
  final String? condition;   // 条件表达式
  final int? loopCount;      // 循环次数
}
```

#### 2. 脚本执行 (Script Execution)

**技术方案**:
- 通过AccessibilityService模拟触控
- 支持延迟、条件判断、循环执行
- 实时显示执行状态

#### 3. 定时任务 (Scheduled Tasks)

**技术方案**:
- 使用Flutter Alarm Manager插件
- 支持一次性/周期性任务
- 后台唤醒执行脚本

### 权限需求

- **无障碍服务**: ACCESSIBILITY_SERVICE（触控模拟）
- **系统悬浮窗**: SYSTEM_ALERT_WINDOW（显示执行状态）
- **电池优化白名单**: REQUEST_IGNORE_BATTERY_OPTIMIZATIONS

### 屏幕适配

- 使用MediaQuery获取设备尺寸
- 动作坐标归一化（0-1范围）
- 执行时根据实际屏幕比例映射

### 数据存储

**Hive存储结构**:
```dart
// 脚本库
@HiveType(typeId: 0)
class Script extends HiveObject {
  @HiveField(0) String id;
  @HiveField(1) String name;
  @HiveField(2) List<ScriptAction> actions;
  @HiveField(3) DateTime createdAt;
  @HiveField(4) Duration duration;
}

// 定时任务
@HiveType(typeId: 1)
class ScheduledTask extends HiveObject {
  @HiveField(0) String id;
  @HiveField(1) String scriptId;
  @HiveField(2) DateTime? executeAt;
  @HiveField(3) String? cron;  // 周期性任务
  @HiveField(4) bool enabled;
}
```

## 开发计划

### Phase 1: 基础框架
- [ ] 初始化Flutter项目
- [ ] 配置依赖（Riverpod、Hive、permission_handler）
- [ ] 搭建基础UI框架
- [ ] 实现主题和导航

### Phase 2: 脚本录制
- [ ] 实现AccessibilityService
- [ ] 录制触控动作
- [ ] 保存脚本到本地

### Phase 3: 脚本执行
- [ ] 实现脚本执行器
- [ ] 触控模拟功能
- [ ] 流程控制（条件/循环）

### Phase 4: 定时任务
- [ ] 集成Alarm Manager
- [ ] 定时任务管理UI
- [ ] 后台执行能力

### Phase 5: 优化完善
- [ ] 屏幕适配
- [ ] 错误处理
- [ ] 性能优化
