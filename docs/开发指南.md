# KeyHelp 开发指南

## 项目结构

```
keyhelp/
├── lib/
│   ├── main.dart                 # 应用入口
│   ├── app.dart                  # 根组件
│   ├── config/                   # 配置
│   │   ├── theme.dart            # 主题配置
│   │   └── constants.dart        # 常量定义
│   ├── core/                     # 核心功能
│   │   ├── services/             # 服务层
│   │   │   ├── accessibility_service.dart
│   │   │   ├── script_recorder.dart
│   │   │   ├── script_executor.dart
│   │   │   └── scheduler.dart
│   │   ├── models/               # 数据模型
│   │   │   ├── script.dart
│   │   │   ├── action.dart
│   │   │   └── scheduled_task.dart
│   │   └── repositories/         # 数据仓库
│   │       ├── script_repository.dart
│   │       └── task_repository.dart
│   ├── features/                 # 功能模块
│   │   ├── home/                 # 首页
│   │   ├── record/               # 录制页面
│   │   ├── scripts/              # 脚本列表
│   │   ├── execute/              # 执行页面
│   │   └── schedule/             # 定时任务
│   └── shared/                   # 共享组件
│       ├── widgets/              # 通用组件
│       └── utils/                # 工具类
├── scripts/                     # 运行脚本
├── logs/                         # 日志目录
├── docs/                         # 文档
├── discuss/                      # 讨论文档
└── android/                      # Android配置
```

## 开发环境要求

- Flutter 3.24+
- Dart 3.5+
- Android SDK 21+ (支持安卓5.0+)
- Android Studio 或 VS Code

## 添加新功能

### 1. 创建新的功能页面

在 `lib/features/` 下创建新目录：

```dart
// lib/features/example/example_page.dart
import 'package:flutter/material.dart';

class ExamplePage extends StatelessWidget {
  const ExamplePage({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('示例页面')),
      body: Container(),
    );
  }
}
```

### 2. 添加数据模型

在 `lib/core/models/` 下创建模型类：

```dart
// lib/core/models/example.dart
import 'package:hive/hive.dart';

part 'example.g.dart';

@HiveType(typeId: 4)
class ExampleModel extends HiveObject {
  @HiveField(0)
  String id;

  @HiveField(1)
  String name;

  ExampleModel({
    required this.id,
    required this.name,
  });
}
```

生成Hive适配器：

```bash
flutter pub run build_runner build
```

### 3. 添加服务

在 `lib/core/services/` 下创建服务类：

```dart
// lib/core/services/example_service.dart
class ExampleService {
  static final ExampleService _instance = ExampleService._internal();
  factory ExampleService() => _instance;
  ExampleService._internal();

  Future<void> doSomething() async {
    // 实现逻辑
  }
}
```

### 4. 使用Riverpod状态管理

在页面中使用Provider：

```dart
// 创建Provider
final exampleProvider = Provider<ExampleService>((ref) {
  return ExampleService();
});

// 在页面中使用
class ExamplePage extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final service = ref.watch(exampleProvider);
    
    return Container();
  }
}
```

## 调试技巧

### 1. 查看日志

应用日志会自动输出到 `logs/` 目录：

```bash
tail -f logs/keyhelp_*.log
```

### 2. Flutter DevTools

运行应用后，按 `d` 打开DevTools，可以：
- 检查Widget树
- 查看性能分析
- 调试网络请求
- 查看日志

### 3. 热重载

在开发过程中，保存文件后按 `r` 触发热重载。

### 4. 热重启

修改代码结构后，按 `R` 触发热重启。

## 代码规范

### Dart代码风格

- 使用 `dart format` 格式化代码
- 使用 `dart analyze` 进行静态分析
- 遵循 Effective Dart 指南

### 文件命名

- 文件名使用小写字母和下划线：`script_executor.dart`
- 类名使用大驼峰命名：`ScriptExecutor`
- 变量名使用小驼峰命名：`scriptExecutor`
- 常量使用小驼峰命名：`kMaxActions`

### 注释规范

- 公共API必须添加注释
- 复杂逻辑需要添加说明
- 不要添加无意义的注释

## 性能优化

### 1. 使用const构造函数

```dart
const Card(
  child: Text('示例'),
)
```

### 2. 避免不必要的Widget重建

使用 `const`、`buildWhen`、`select` 等优化方式。

### 3. 使用ListView.builder

对于长列表，使用 `ListView.builder` 代替 `ListView`。

## 测试

运行测试：

```bash
flutter test
```

生成覆盖率报告：

```bash
flutter test --coverage
genhtml coverage/lcov.info -o coverage/html
```

## 构建和发布

### Debug构建

```bash
flutter run
```

### Release构建

```bash
flutter build apk --release
```

### 混淆和签名

在 `android/app/build.gradle` 中配置签名和混淆规则。

## 依赖管理

添加新依赖：

```yaml
# pubspec.yaml
dependencies:
  new_package: ^1.0.0
```

运行：

```bash
flutter pub get
```

升级依赖：

```bash
flutter pub upgrade
```
