# 脚本保存问题修复

## 问题描述

用户反馈：可以录制成功（能看到"录制点击"和"录制时长"日志），但是保存后脚本在列表中没有显示。

## 根本原因

### 实例分离问题

原来的架构中存在两个独立的实例：

1. **ScriptRecorder** - 通过Provider创建的实例
   ```dart
   final recorderProvider = Provider<ScriptRecorder>((ref) {
     return ScriptRecorder();
   });
   ```

2. **AccessibilityService** - 在ScriptRecorder内部创建的实例
   ```dart
   class ScriptRecorder {
     final AccessibilityService _accessibilityService;
     ScriptRecorder() : _accessibilityService = AccessibilityService() {
       _accessibilityService.actionStream.listen((action) {
         if (_accessibilityService.isRecording) {
           _actions.add(action);
         }
       });
     }
   ```

3. **页面中的另一个AccessibilityService**
   ```dart
   final accessibilityServiceProvider = Provider<AccessibilityService>((ref) => AccessibilityService());
   ```

### 数据流问题

```
record_page.dart
    ↓ 调用
_onTap(x, y)
    ↓
accessibilityServiceProvider.recordTap(x, y)  // 这是另一个实例！
    ↓
AccessibilityService._recordedActions.add()  // 数据在这里
    ↓
但保存时用的是...
recorder.createScript(name)
    ↓
recorder.actions  // 这是空的，因为数据在另一个实例中！
```

## 解决方案

### 1. 简化ScriptRecorder

移除对AccessibilityService的依赖，直接管理数据：

```dart
class ScriptRecorder {
  List<ScriptAction> _actions = [];
  bool _isRecording = false;

  void recordTap(double x, double y) {
    if (!_isRecording) return;
    final action = ScriptAction(type: ActionType.tap, x: x, y: y);
    _actions.add(action);
  }

  Script createScript(String name) {
    return Script(
      id: DateTime.now().millisecondsSinceEpoch.toString(),
      name: name,
      actions: List.from(_actions),
      createdAt: DateTime.now(),
      duration: _startTime != null ? DateTime.now().difference(_startTime!) : Duration.zero,
    );
  }
}
```

### 2. 使用TouchRecorder捕获触摸

在UI层使用GestureDetector捕获真实的触摸事件：

```dart
TouchRecorder(
  isRecording: _isRecording,
  onTap: _onTap,
  onSwipe: _onSwipe,
  onLongPress: _onLongPress,
  child: ...,
)
```

### 3. 移除冗余实例

删除record_page.dart中的`accessibilityServiceProvider`，只使用`recorderProvider`。

### 4. 状态同步

确保`_isRecording`状态和`recorder.isRecording`同步：

```dart
void _toggleRecording() {
  final recorder = ref.read(recorderProvider);

  if (recorder.isRecording) {
    recorder.stopRecording();
    setState(() {
      _isRecording = false;
      _duration = '00:00:00';
    });
  } else {
    recorder.startRecording();
    setState(() {
      _isRecording = true;
      _actionCount = 0;
      _duration = '00:00:00';
    });
  }
}
```

## 修改的文件

### lib/core/services/script_recorder.dart

**改动**:
- 移除AccessibilityService依赖
- 简化实现，直接管理`_actions`列表
- 添加`recordTap`, `recordSwipe`, `recordLongPress`方法
- 保持`startRecording`, `stopRecording`, `createScript`接口

### lib/shared/widgets/touch_recorder.dart

**改动**:
- 新增`isRecording`参数
- 支持非录制模式（不拦截触摸）
- 智能判断触摸类型

### lib/shared/widgets/recording_overlay.dart

**新增**:
- 录制状态指示器
- 顶部红色横幅

### lib/features/record/record_page.dart

**改动**:
- 集成TouchRecorder覆盖整个页面
- 使用recorderProvider替代accessibilityServiceProvider
- 移除冗余的import和状态
- 修复状态同步问题
- 删除重复的大括号

## 测试步骤

### 1. 验证录制

1. 打开"脚本录制"页面
2. 点击"开始"按钮
3. 在屏幕上点击几次
4. 查看统计：动作数量应该增加
5. 查看日志：应该看到"录制点击: (x, y)"

### 2. 验证保存

1. 点击"停止"按钮
2. 点击"保存"按钮
3. 返回首页
4. 点击"脚本列表"
5. 应该能看到刚才保存的脚本

### 3. 验证执行

1. 在脚本列表中找到保存的脚本
2. 点击播放图标
3. 观察是否执行成功
4. 查看日志：应该看到"执行点击"信息

## 架构优势

### 简化后的好处

1. **单一数据源** - 所有动作数据在一个地方管理
2. **清晰的数据流** - 触摸 → ScriptRecorder → Script
3. **易于调试** - 没有跨实例的数据问题
4. **性能更好** - 减少不必要的实例创建

### 保留的功能

- AccessibilityService仍然用于触控模拟（执行脚本）
- TouchRecorder用于触摸捕获（录制脚本）
- 两者各司其职

## 总结

✅ 修复了实例分离导致的数据不同步问题
✅ 简化了ScriptRecorder实现
✅ 集成了TouchRecorder用于真实触摸捕获
✅ 保持状态一致性
✅ 清理了冗余代码

现在脚本应该能够正确保存并在列表中显示了！
