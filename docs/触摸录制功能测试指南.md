# 触摸录制功能测试指南

## 功能说明

已实现基于Flutter GestureDetector的触摸事件录制功能，可以准确捕获用户的点击、滑动和长按操作。

## 测试步骤

### 1. 启用无障碍服务

1. 打开KeyHelp应用
2. 首页右上角显示橙警告图标
3. 点击警告图标，打开系统设置
4. 找到"KeyHelp - KeyHelp自动化工具"
5. 点击并启用无障碍服务开关
6. 返回应用，图标应变为绿色

### 2. 开始录制

1. 点击首页的"脚本录制"卡片
2. 输入脚本名称（如"测试脚本"）
3. 点击"开始"按钮
4. 页面顶部显示红色"录制中..."提示
5. 界面上所有元素变为录制状态

### 3. 执行操作

在录制状态下，您可以：

#### 点击操作
- 快速点击屏幕任意位置
- 持续时间 < 200ms
- 移动距离 < 10像素

#### 滑动操作
- 从一个位置滑动到另一个位置
- 可以是任意方向
- 适合翻页、滚动等操作

#### 长按操作
- 长按某个位置超过800ms
- 适合长按菜单、选择等操作

### 4. 停止并保存

1. 点击"停止"按钮
2. 查看统计：已录制的动作数量、录制时长
3. 点击"保存"按钮
4. 脚本自动保存到本地

### 5. 执行脚本

1. 返回首页
2. 点击"脚本列表"
3. 找到刚才保存的脚本
4. 点击播放图标
5. 无障碍服务会精确回放所有操作

## 技术原理

### 触摸检测

使用Flutter的GestureDetector监听触摸事件：

```dart
GestureDetector(
  onTapDown: (details) {
    // 记录按下位置
    _startX = details.globalPosition.dx;
    _startY = details.globalPosition.dy;
    _startTime = DateTime.now();
  },
  onTapUp: (details) {
    // 记录抬起位置
    _endX = details.globalPosition.dx;
    _endY = details.globalPosition.dy;
    _endTime = DateTime.now();

    // 判断是点击还是滑动
    final duration = _endTime.difference(_startTime);
    final distance = sqrt(pow(_endX - _startX, 2) + pow(_endY - _startY, 2));

    if (duration.inMilliseconds < 200 && distance < 10) {
      // 点击
      recordTap(_endX, _endY);
    } else {
      // 滑动
      recordSwipe(_startX, _startY, _endX, _endY);
    }
  },
  onLongPressEnd: (details) {
    // 长按
    recordLongPress(details.globalPosition.dx, details.globalPosition.dy);
  },
)
```

### 坐标归一化

为了适配不同屏幕分辨率，坐标使用归一化值（0-1范围）：

```dart
// 屏幕实际坐标
final double actualX = details.globalPosition.dx;
final double actualY = details.globalPosition.dy;

// 屏幕尺寸
final Size screenSize = MediaQuery.of(context).size;

// 归一化坐标（0-1）
final double normalizedX = actualX / screenSize.width;
final double normalizedY = actualY / screenSize.height;
```

### 执行时的坐标映射

执行时需要将归一化坐标映射回实际屏幕：

```dart
// 获取当前屏幕尺寸
final Size screenSize = MediaQuery.of(context).size;

// 归一化坐标转实际坐标
final double actualX = normalizedX * screenSize.width;
final double actualY = normalizedY * screenSize.height;
```

## 注意事项

### 1. 录制时

- 保持屏幕方向不变
- 避免录制过程中旋转设备
- 动作要清晰明确
- 建议分步录制复杂操作

### 2. 执行时

- 在相同分辨率的设备上执行
- 确保屏幕方向与录制时一致
- 避免执行过程中切换应用
- 给脚本足够的执行时间

### 3. 精度问题

如果执行不准确：

1. **检查屏幕分辨率**
   - 录制和执行时分辨率不同会导致坐标偏移

2. **重新录制**
   - 在目标设备上重新录制脚本

3. **调整动作间隔**
   - 录制时动作不要太快
   - 执行时给予足够的加载时间

## 调试技巧

### 查看日志

```bash
# 查看所有KeyHelp日志
adb logcat | grep KeyHelp

# 查看录制事件
adb logcat -s KeyHelpAccessibility
```

### 测试单个操作

录制一个简单的测试脚本：

1. 点击屏幕中心
2. 停止录制
3. 保存脚本
4. 执行脚本
5. 观察是否成功点击中心位置

### 录制复杂脚本

对于复杂的操作流程：

1. 分段录制
2. 每段录制后保存
3. 执行时可以组合使用
4. 方便调试和修改

## 常见问题

### 1. 录制时没有反应

**原因**: 录制未开始或点击太慢

**解决方法**:
- 确保顶部显示"录制中..."
- 点击速度要快（< 200ms）
- 查看日志确认事件被捕获

### 2. 滑动被识别为点击

**原因**: 滑动距离或时间太短

**解决方法**:
- 增加滑动距离（> 10像素）
- 确保滑动过程持续足够时间
- 手指不要抖动

### 3. 长按没有录制

**原因**: 长按时间不够

**解决方法**:
- 保持按住超过800ms
- 不要移动手指
- 等待触发长按反馈

### 4. 执行位置不准确

**原因**: 分辨率不同或UI布局变化

**解决方法**:
- 相同设备相同分辨率下执行
- 检查目标应用是否有自适应布局
- 考虑使用相对定位（如"按钮右侧"）

## 优化建议

### 短期优化

1. **添加动作预览**
   - 显示每个动作的坐标位置
   - 支持手动调整坐标

2. **实时坐标显示**
   - 录制时显示实时坐标
   - 方便用户确认操作

3. **动作编辑功能**
   - 删除误操作
   - 插入新动作
   - 调整参数

### 中期优化

1. **相对定位**
   - 支持相对于某个元素的位置
   - 如"按钮右下方50像素"

2. **图像识别**
   - 使用OCR识别文字位置
   - 自动匹配目标元素

3. **条件判断**
   - 根据屏幕内容决定后续操作
   - 如"如果出现广告则关闭"

### 长期优化

1. **智能录制**
   - AI识别操作意图
   - 自动优化脚本

2. **跨设备适配**
   - 自动适配不同分辨率
   - 云端坐标转换

3. **脚本市场**
   - 分享常用脚本
   - 模板和预设

## 测试清单

- [ ] 无障碍服务已启用
- [ ] 录制功能正常
- [ ] 点击操作被正确捕获
- [ ] 滑动操作被正确捕获
- [ ] 长按操作被正确捕获
- [ ] 坐标归一化正确
- [ ] 脚本保存成功
- [ ] 脚本执行准确
- [ ] 不同分辨率下测试
- [ ] 横竖屏切换测试

## 总结

✅ 已实现基于GestureDetector的触摸录制
✅ 支持点击、滑动、长按三种操作
✅ 坐标归一化适配不同屏幕
✅ 提供清晰的录制引导
✅ 完整的错误处理和日志

现在您可以开始测试录制功能了！如有问题请查看日志或文档。
